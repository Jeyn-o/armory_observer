name: Torn Armory Monthly Fetch

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      year:
        description: 'Year to fetch (YYYY)'
        required: true
      month:
        description: 'Month to fetch (MM)'
        required: true

jobs:
  fetch-month:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Configure git identity
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Fetch entire month
        run: |
          YEAR=${{ github.event.inputs.year }}
          MONTH=${{ github.event.inputs.month }}

          # Get last day of month safely
          LAST_DAY=$(date -d "$YEAR-$MONTH-01 +1 month -1 day" +%d)
          echo "Fetching logs for $YEAR-$MONTH (1-$LAST_DAY)..."

          for DAY in $(seq -w 1 $LAST_DAY); do
            echo "------------------------------"
            echo "Fetching $YEAR-$MONTH-$DAY..."
            
            # Run Node script, continue on error
            if ! node runtime.js "$YEAR-$MONTH-$DAY"; then
              echo "Warning: runtime.js failed for $YEAR-$MONTH-$DAY, continuing..."
            fi

            echo "Sleeping 60 seconds before next day..."
            sleep 60
          done
